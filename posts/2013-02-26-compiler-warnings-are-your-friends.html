<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>Self-Cultivation of A Coder - Compiler Warnings are Your Friends</title>
        <link rel="stylesheet" type="text/css" href="../css/default.css" />
    </head>
    <body>
        <div id="header">
            <div id="logo">
                <a href="../">Self-Cultivation of A Coder</a>
            </div>
            <div id="navigation">
                <a href="../about.html">About</a>
                <a href="../archive.html">Archive</a>
            </div>
        </div>

        <div id="content">
            <h1>Compiler Warnings are Your Friends</h1>

            <div class="info">
	Posted on February 26, 2013
	
</div>

<h2 id="origin">Origin</h2>
<p>One of my colleagues has posted a blog talking about a bug related with a GCC option <code>-fstrict-aliasing</code>, and someone pointed out that the compiler has already warned them about the bug in the compiling log, but that team just ignored the warning.</p>
<p>Then you may suggest all of us should treat compiling warnings seriously, it couldn’t turn into a bug, waste lots of time of many colleagues.</p>
<p>So why not turn on <code>-Werror</code> into compile flags always, then build would fail instantly if there are warnings reported, then engineers won’t ignore them unconsciously? In fact, many components in our system has already took this action.</p>
<h2 id="reasons-for-havent-doing-so">Reasons for Haven’t Doing So</h2>
<p>But why not all of C/C++ components using <code>-Werror</code>? I guess:</p>
<ol style="list-style-type: decimal">
<li>They’re legacy code, and there are too many warnings in their components, if they turn on <code>-Werror</code>, the CI build would fail for a long time and the team would got blamed by many angry colleagues.</li>
<li>Some compiler warnings are really not problems, or not worth to fix them all.</li>
</ol>
<h2 id="solution-for-1">Solution for #1</h2>
<ol style="list-style-type: decimal">
<li>when you have time, or feel bored, check out a clean copy of the code.</li>
<li>turn on <code>-Werror</code>, compile;</li>
<li>fix some of the warnings reported by compiler in a time-box;</li>
<li>turn off <code>-Werror</code>, check-in those fix;</li>
<li>repeat 1-4 until all warnings are fixed, then turn on the flag permanently.</li>
</ol>
<h2 id="solution-for-2">Solution for #2</h2>
<p>Before doing below actions, discuss with other experts and be 100% sure there are no solutions for the warnings you’re dealing with, in my experience that’s not the case in most of times. But if you’re really on bad luck, try below:</p>
<ol style="list-style-type: decimal">
<li>Turn off some specific compile options by <code>-Wno-&lt;xxx&gt;</code>, e.g. <code>-Wno-write-strings, -Wno-long-long, -Wno-unused-value</code></li>
<li>Split code into different groups, configure different compile flags for different groups of code. e.g. use “<code>-Wall -Wextra -Wno-write-strings</code>” for C source code, use “<code>-Wall -Wextra -pedantic-errors</code>” for C++ source code, use <code>-Wpermissive</code> for the source code generated by some code generating scripts without self-discipline. Usually this kind of configuration requires makefile support.</li>
</ol>
<p>But why should I care those dirty secrets of compilers? because:</p>
<h2 id="compiler-warnings-are-your-friends">Compiler Warnings are Your Friends</h2>
<ul>
<li>Catch Bugs Before Testing</li>
</ul>
<p>For example we have below code:</p>
<pre class="sourceCode c"><code class="sourceCode c"><span class="kw">if</span> (queue_handle = msg_queue_handle) {
    printf(<span class="st">&quot;message queue is empty.</span><span class="ch">\n</span><span class="st">&quot;</span>);
}</code></pre>
<p>Compiler can help you to catch the annoying bug:</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">src</span>/demo.c:<span class="kw">247</span>:19: warning: using the result of an assignment as a condition without parentheses [-Wparentheses]
    <span class="kw">if</span> <span class="kw">(queue_handle</span> = msg_queue_handle<span class="kw">)</span>
        <span class="kw">~~~~~~~~~~~~~</span>^<span class="kw">~~~~~~~~~~~~~~~~~</span>
<span class="kw">src</span>/demo.c:<span class="kw">247</span>:19: note: place parentheses around the assignment to silence this warning
    <span class="kw">if</span> <span class="kw">(queue_handle</span> = msg_queue_handle<span class="kw">)</span>
                     ^
        <span class="kw">(</span>                              <span class="kw">)</span></code></pre>
<p>below code is another real-life example:</p>
<pre class="sourceCode c"><code class="sourceCode c"><span class="kw">if</span> (tmp_value != (SUM_OF_VALUES - last_value));
{
    <span class="co">//code here...</span>
}</code></pre>
<p>Can you find the bug at first glance? Probably not, but the compiler never get drunk:</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">..</span>/uglified_file_name.c:<span class="kw">161</span>:52: error: if statement has empty body [-Werror,-Wempty-body]
<span class="kw">if</span> <span class="kw">(tmp_value</span> != (SUM_OF_VALUES - last_value<span class="kw">)</span>);
                                             ^</code></pre>
<ul>
<li>Catch Bugs that are Hard to Find Even in Testing</li>
</ul>
<pre class="sourceCode c"><code class="sourceCode c"><span class="kw">if</span> (TYPE_T_VIP == type) {
    status = get_customer_name(name, parent_name);
    <span class="kw">if</span> (status != OK) {
        <span class="kw">return</span> status;
    }

    <span class="co">// bunch of ugly code here...</span>

    status = decode_customer_info(parent_name, &amp;parent_id, &amp;type);
    <span class="kw">if</span> (status != OK) {
        log_error(
            MODULE_CUSTOMER,
            __func__,
            <span class="st">&quot;get parent id of %s failed, status 0x%x&quot;</span>,
            status
        );

        <span class="kw">return</span> status;
    }
}

acquireLock(customer_entry_lock);
status = update_customer(customer_db,
    parent_id,
    &amp;db_customer_profile,
    &amp;db_vip_profile);
releaseLock(customer_entry_lock);</code></pre>
<p>Like above code, they appears in a very long function, bugs are growing very easily in complex logic, and again compiler can find it for you:</p>
<pre class="sourceCode c"><code class="sourceCode c">../customers.c:<span class="dv">556</span>:<span class="dv">11</span>: error: variable 'parent_id' is used uninitialized whenever '<span class="kw">if</span>' condition is false
      [-Werror,-Wsometimes-uninitialized]
      <span class="kw">if</span> (TYPE_T_VIP == type) {
          ^~~~~~~~~~~~~~~~~~</code></pre>
<p>If the first if-statement evaluated to false, then the variable <code>parent_id</code> would never be initialized by <code>decode_customer_info</code>, so it’s uninitialized when used in <code>update_customer(...)</code>.</p>
<h2 id="summary">Summary</h2>
<ul>
<li>Compiler warnings are helpful, combined use with <code>-Werror</code> can prevent bugs at the very beginning.</li>
<li>Some warnings are annoying, but you have ways to suppress them.</li>
</ul>
<h2 id="reference">Reference</h2>
<ul>
<li><a href="http://gcc.gnu.org/onlinedocs/gcc/Warning-Options.html">GCC Warning Options</a></li>
</ul>
<h2 id="backwards-reference">Backwards Reference</h2>
<ul>
<li><a href="../posts/2013-01-13-foo-and-foo-void.html">What’s the difference between ‘foo()’ and ‘foo(void)’?</a></li>
<li><a href="../posts/2013-04-25-printf-llu.html">Format Types Mismatch in printf/fprintf</a></li>
<li><a href="2014-02-24-include-header.html">Do I need to include .h file in .c with same name?</a></li>
<li><a href="../posts/2014-09-01-code-optimization.html">On Code Optimization</a></li>
</ul>


        </div>
        <div id="footer">
            Site proudly generated by
            <a href="http://jaspervdj.be/hakyll">Hakyll</a>
        </div>
    </body>
</html>
