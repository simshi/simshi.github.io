---------------------
title: Compiler Warnings are Your Friends
tags: compiler, c/c++
---------------------

## Origin

One of my colleagues has posted a blog talking about a bug related with a GCC option `-fstrict-aliasing`, and someone pointed out that the compiler has already warned them about the bug in the compiling log, but that team just ignored the warning.

Then you may suggest all of us should treat compiling warnings seriously, it couldn't turn into a bug, waste lots of time of many colleagues.

So why not turn on `-Werror` into compile flags always, then build would fail instantly if there are warnings reported, then engineers won't ignore them unconsciously? In fact, many components in our system has already took this action.

## Reasons for Haven't Doing So

But why not all of C/C++ components using `-Werror`? I guess:

1. They're legacy code, and there are too many warnings in their components, if they turn on `-Werror`, the CI build would fail for a long time and the team would got blamed by many angry colleagues.
1. Some compiler warnings are really not problems, or not worth to fix them all.

## Solution for #1

1. when you have time, or feel bored, check out a clean copy of the code.
1. turn on `-Werror`, compile;
1. fix some of the warnings reported by compiler in a time-box;
1. turn off `-Werror`, check-in those fix;
1. repeat 1-4 until all warnings are fixed, then turn on the flag permanently.

## Solution for #2

Before doing below actions, discuss with other experts and be 100% sure there are no solutions for the warnings you're dealing with, in my experience that's not the case in most of times. But if you're really on bad luck, try below:

1. Turn off some specific compile options by `-Wno-<xxx>`, e.g. `-Wno-write-strings, -Wno-long-long, -Wno-unused-value`
1. Split code into different groups, configure different compile flags for different groups of code. e.g. use "`-Wall -Wextra -Wno-write-strings`" for C source code, use "`-Wall -Wextra -pedantic-errors`" for C++ source code, use `-Wpermissive` for the source code generated by some code generating scripts without self-discipline. Usually this kind of configuration requires makefile support.

But why should I care those dirty secrets of compilers? because:

## Compiler Warnings are Your Friends

- Catch Bugs Before Testing

For example we have below code:

```c
if (queue_handle = msg_queue_handle) {
    printf("message queue is empty.\n");
}
```

Compiler can help you to catch the annoying bug:

``` bash
src/demo.c:247:19: warning: using the result of an assignment as a condition without parentheses [-Wparentheses]
    if (queue_handle = msg_queue_handle)
        ~~~~~~~~~~~~~^~~~~~~~~~~~~~~~~~
src/demo.c:247:19: note: place parentheses around the assignment to silence this warning
    if (queue_handle = msg_queue_handle)
                     ^
        (                              )
```

below code is another real-life example:

```c
if (tmp_value != (SUM_OF_VALUES - last_value));
{
    //code here...
}
```

Can you find the bug at first glance? Probably not, but the compiler never get drunk:

``` bash
../uglified_file_name.c:161:52: error: if statement has empty body [-Werror,-Wempty-body]
if (tmp_value != (SUM_OF_VALUES - last_value));
                                             ^
```

- Catch Bugs that are Hard to Find Even in Testing

```c
if (TYPE_T_VIP == type) {
    status = get_customer_name(name, parent_name);
    if (status != OK) {
        return status;
    }

    // bunch of ugly code here...

    status = decode_customer_info(parent_name, &parent_id, &type);
    if (status != OK) {
        log_error(
            MODULE_CUSTOMER,
            __func__,
            "get parent id of %s failed, status 0x%x",
            status
        );

        return status;
    }
}

acquireLock(customer_entry_lock);
status = update_customer(customer_db,
    parent_id,
    &db_customer_profile,
    &db_vip_profile);
releaseLock(customer_entry_lock);
```

Like above code, they appears in a very long function, bugs are growing very easily in complex logic, and again compiler can find it for you:

``` c
../customers.c:556:11: error: variable 'parent_id' is used uninitialized whenever 'if' condition is false
      [-Werror,-Wsometimes-uninitialized]
      if (TYPE_T_VIP == type) {
          ^~~~~~~~~~~~~~~~~~
```

If the first if-statement evaluated to false, then the variable `parent_id` would never be initialized by `decode_customer_info`, so it's uninitialized when used in `update_customer(...)`.

## Summary

- Compiler warnings are helpful, combined use with `-Werror` can prevent bugs at the very beginning.
- Some warnings are annoying, but you have ways to suppress them.

## Reference

- [GCC Warning Options](http://gcc.gnu.org/onlinedocs/gcc/Warning-Options.html)

## Backwards Reference

- [What's the difference between 'foo()' and 'foo(void)'?](/posts/2013-01-13-foo-and-foo-void.html)
- [Format Types Mismatch in printf/fprintf](/posts/2013-04-25-printf-llu.html)
- [Do I need to include .h file in .c with same name?](2014-02-24-include-header.html)
- [On Code Optimization](/posts/2014-09-01-code-optimization.html)

